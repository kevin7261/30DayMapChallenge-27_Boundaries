<script>
  /**
   * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   * ğŸ—ºï¸ MapTab.vue - D3.js å°ç£åœ°åœ–çµ„ä»¶
   * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   *
   * @fileoverview
   * é€™æ˜¯ä¸€å€‹åŸºæ–¼ D3.js çš„å°ç£åœ°åœ–è¦–è¦ºåŒ–çµ„ä»¶ï¼ŒåŒæ™‚é¡¯ç¤ºç¸£å¸‚ç•Œç·šå’Œç™»é©ç†±ç¶²æ ¼æ•¸æ“šã€‚
   * æœ¬çµ„ä»¶è² è²¬è¼‰å…¥ã€è™•ç†å’Œæ¸²æŸ“å°ç£ç›´è½„å¸‚ã€ç¸£(å¸‚)ç•Œç·šå’Œç™»é©ç†±ç—…ä¾‹ç¶²æ ¼æ•¸æ“šã€‚
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ“‹ æ ¸å¿ƒåŠŸèƒ½
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * 1. ç¸£å¸‚é‚Šç•Œæ¸²æŸ“ï¼š
   *    âœ“ è¼‰å…¥ç›´è½„å¸‚ã€ç¸£(å¸‚)ç•Œç·š1140318.geojson
   *    âœ“ ç¹ªè£½æ‰€æœ‰å°ç£ç›´è½„å¸‚ã€ç¸£(å¸‚)ç•Œç·š
   *
   * 2. ç™»é©ç†±ç¶²æ ¼æ¸²æŸ“ï¼š
   *    âœ“ è¼‰å…¥ dengue_grid_counts_1km_2023_land_only.geojson
   *    âœ“ æ ¹æ“š level å±¬æ€§ç¹ªè£½5ç´šé¢¨éšªç­‰ç´šç¶²æ ¼
   *    âœ“ åªé¡¯ç¤ºç—…ä¾‹æ•¸ > 0 çš„ç¶²æ ¼
   *    âœ“ ä½¿ç”¨5ç´šè‰²ç¥¨ï¼šæ·±è—(1) â†’ ç¶ (2) â†’ é»ƒæ©™(3) â†’ æ©™(4) â†’ ç´…(5)ï¼ˆæœ€ä¸Šå±¤ï¼‰
   *
   * 3. è¦–è¦ºå…ƒç´ ï¼š
   *    âœ“ ç¸£å¸‚ç•Œç·šï¼šæ·ºç°ç´°é‚Šæ¡†ï¼Œç„¡å¡«å……ï¼ˆåº•å±¤ï¼‰
   *    âœ“ ç™»é©ç†±ç¶²æ ¼ï¼š5ç´šè‰²ç¥¨å¡«å……ï¼Œç„¡é‚Šæ¡†ï¼ˆæœ€ä¸Šå±¤ï¼‰
   *    âœ“ ç™½è‰²åœ°åœ–èƒŒæ™¯
   *
   * 4. äº¤äº’åŠŸèƒ½ï¼š
   *    âœ“ æ»¾è¼ªç¸®æ”¾æ§åˆ¶
   *    âœ“ æ‹–å‹•å¹³ç§»å°èˆª
   *    âœ“ æ»‘é¼ æ‡¸åœé¡¯ç¤ºç¶²æ ¼å±¬æ€§è³‡è¨Š
   *    âœ“ ç¶²æ ¼é«˜äº®æ•ˆæœ
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ¨ é…è‰²ä¸»é¡Œ
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ç™½è‰²      #ffffff  â†’ åœ°åœ–èƒŒæ™¯
   * æ·ºç°è‰²    #cccccc  â†’ ç¸£å¸‚é‚Šæ¡†
   * ç„¡å¡«å……    none     â†’ ç¸£å¸‚å€åŸŸ
   * 5ç´šè‰²ç¥¨            â†’ ç™»é©ç†±é¢¨éšªç­‰ç´šï¼ˆæœ€ä¸Šå±¤ï¼‰
   *   Level 1  #1a237e â†’ æ·±è—è‰²
   *   Level 2  #4caf50 â†’ ç¶ è‰²
   *   Level 3  #fbc02d â†’ é»ƒæ©™è‰²
   *   Level 4  #ff6f00 â†’ æ©™è‰²
   *   Level 5  #d32f2f â†’ ç´…è‰²
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ› ï¸ æŠ€è¡“æ£§
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * @requires vue                 - Vue 3.2+ (Composition API)
   * @requires d3                  - D3.js 7.8+ (åœ°åœ–ç¹ªè£½åº«)
   * @requires @/stores/dataStore  - Pinia ç‹€æ…‹ç®¡ç†
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ“ æ•¸æ“šä¾†æº
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ç›´è½„å¸‚ã€ç¸£(å¸‚)ç•Œç·šï¼šç›´è½„å¸‚ã€ç¸£(å¸‚)ç•Œç·š1140318.geojson
   * ç™»é©ç†±ç¶²æ ¼æ•¸æ“šï¼šdengue_grid_counts_1km_2023_land_only.geojson
   * è·¯å¾‘ï¼špublic/data/geojson/
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ”§ ä½¿ç”¨æ–¹å¼
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * <MapTab @map-ready="handleMapReady" />
   *
   * @event map-ready - åœ°åœ–åˆå§‹åŒ–å®Œæˆæ™‚è§¸ç™¼ï¼Œè¿”å›åœ°åœ–å¯¦ä¾‹
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ“ ç¶­è­·è€…
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * @author Kevin Cheng
   * @version 4.0.0
   * @since 2024
   * @license MIT
   *
   * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   */

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ“¦ ä¾è³´å°å…¥ (Dependencies Import)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Vue 3 æ ¸å¿ƒåŠŸèƒ½
  import { ref, onMounted, onUnmounted, nextTick } from 'vue';

  // D3.js åœ°åœ–åº«
  import * as d3 from 'd3';

  // Pinia ç‹€æ…‹ç®¡ç†
  import { useDataStore } from '@/stores/dataStore';

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ¯ çµ„ä»¶å®šç¾© (Component Definition)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  export default {
    name: 'MapTab',

    // çµ„ä»¶è§¸ç™¼çš„äº‹ä»¶
    emits: [
      'map-ready', // åœ°åœ–åˆå§‹åŒ–å®Œæˆæ™‚è§¸ç™¼ï¼Œå‚³éåœ°åœ–å¯¦ä¾‹
    ],

    /**
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * ğŸ¬ çµ„ä»¶è¨­ç½®å‡½æ•¸ (Component Setup Function)
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * ä½¿ç”¨ Vue 3 Composition API è¨­ç½®çµ„ä»¶é‚è¼¯
     *
     * @param {Object} _ - Propsï¼ˆæœ¬çµ„ä»¶ä¸ä½¿ç”¨ï¼‰
     * @param {Object} context - è¨­ç½®ä¸Šä¸‹æ–‡
     * @param {Function} context.emit - äº‹ä»¶è§¸ç™¼å‡½æ•¸
     * @returns {Object} è¿”å›æ¨¡æ¿å¯ç”¨çš„éŸ¿æ‡‰å¼æ•¸æ“šå’Œæ–¹æ³•
     */
    setup(_, { emit }) {
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“¦ ç‹€æ…‹ç®¡ç†èˆ‡ä¾è³´ (State Management & Dependencies)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      // Pinia æ•¸æ“šå­˜å„²ï¼ˆä¿ç•™ä¾›æœªä¾†æ“´å±•ä½¿ç”¨ï¼‰
      // eslint-disable-next-line no-unused-vars
      const dataStore = useDataStore();

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ—ºï¸ åœ°åœ–ç›¸é—œè®Šæ•¸ (Map-Related Variables)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      /**
       * åœ°åœ– DOM å®¹å™¨å¼•ç”¨
       * @type {Ref<HTMLElement|null>}
       */
      const mapContainer = ref(null);

      /**
       * D3.js SVG å…ƒç´ 
       * @type {d3.Selection|null}
       */
      let svg = null;

      /**
       * D3.js æŠ•å½±å‡½æ•¸
       * @type {d3.GeoProjection|null}
       */
      let projection = null;

      /**
       * D3.js è·¯å¾‘ç”Ÿæˆå™¨
       * @type {d3.GeoPath|null}
       */
      let path = null;

      /**
       * D3.js ç¸®æ”¾è¡Œç‚º
       * @type {d3.ZoomBehavior|null}
       */
      let zoom = null;

      /**
       * SVG ä¸»å®¹å™¨çµ„
       * @type {d3.Selection|null}
       */
      let g = null;

      /**
       * å·¥å…·æç¤ºå…ƒç´ 
       * @type {HTMLElement|null}
       */
      let tooltip = null;

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ›ï¸ æ§åˆ¶ç‹€æ…‹ (Control States)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      /**
       * åœ°åœ–å°±ç·’ç‹€æ…‹æ¨™è¨˜
       * true = åœ°åœ–å·²åˆå§‹åŒ–å®Œæˆï¼Œfalse = å°šæœªåˆå§‹åŒ–
       * @type {Ref<boolean>}
       */
      const isMapReady = ref(false);

      /**
       * åœ°åœ–å®¹å™¨å”¯ä¸€ ID
       * ä½¿ç”¨éš¨æ©Ÿå­—ç¬¦ä¸²ç¢ºä¿å¤šå¯¦ä¾‹æ™‚ä¸æœƒè¡çª
       * @type {Ref<string>}
       */
      const mapContainerId = ref(`leaflet-map-${Math.random().toString(36).substr(2, 9)}`);

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“Š GeoJSON æ•¸æ“šå„²å­˜ (GeoJSON Data Storage)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      /**
       * ç¸£å¸‚ GeoJSON æ•¸æ“š
       * ä¾†æºï¼šç›´è½„å¸‚ã€ç¸£(å¸‚)ç•Œç·š1140318.geojson
       * @type {Ref<Object|null>}
       */
      const countyData = ref(null);

      /**
       * ç™»é©ç†±ç¶²æ ¼ GeoJSON æ•¸æ“š
       * ä¾†æºï¼šdengue_grid_counts_1km_2023_land_only.geojson
       * @type {Ref<Object|null>}
       */
      const dengueData = ref(null);

      /**
       * ğŸ“¥ è¼‰å…¥ç›´è½„å¸‚ã€ç¸£(å¸‚)ç•Œç·š GeoJSON æ•¸æ“š
       */
      const loadCountyData = async () => {
        try {
          console.log('[MapTab] é–‹å§‹è¼‰å…¥ç›´è½„å¸‚ã€ç¸£(å¸‚)ç•Œç·š GeoJSON æ•¸æ“š...');

          // è¼‰å…¥ç¸£å¸‚ GeoJSON æª”æ¡ˆ
          const countyResponse = await fetch(
            `${process.env.BASE_URL}data/geojson/ç›´è½„å¸‚ã€ç¸£(å¸‚)ç•Œç·š1140318.geojson`
          );

          // æª¢æŸ¥éŸ¿æ‡‰
          if (!countyResponse.ok) {
            throw new Error(`ç›´è½„å¸‚ã€ç¸£(å¸‚)ç•Œç·šæ•¸æ“šè¼‰å…¥å¤±æ•—: HTTP ${countyResponse.status}`);
          }

          // è§£æ JSON
          countyData.value = await countyResponse.json();

          console.log('[MapTab] ç›´è½„å¸‚ã€ç¸£(å¸‚)ç•Œç·šæ•¸æ“šè¼‰å…¥æˆåŠŸ');
          console.log('  - ç¸£å¸‚æ•¸é‡:', countyData.value.features?.length || 0);

          return true;
        } catch (error) {
          console.error('[MapTab] ç›´è½„å¸‚ã€ç¸£(å¸‚)ç•Œç·šæ•¸æ“šè¼‰å…¥å¤±æ•—:', error);
          return false;
        }
      };

      /**
       * ğŸ› ï¸ å‰µå»ºå·¥å…·æç¤ºå…ƒç´ 
       */
      const createTooltip = () => {
        if (!mapContainer.value) return;

        // ç§»é™¤å·²å­˜åœ¨çš„å·¥å…·æç¤º
        const existingTooltip = mapContainer.value.querySelector('.map-tooltip');
        if (existingTooltip) {
          existingTooltip.remove();
        }

        // å‰µå»ºæ–°çš„å·¥å…·æç¤ºå…ƒç´ 
        tooltip = document.createElement('div');
        tooltip.className = 'map-tooltip';
        tooltip.style.position = 'absolute';
        tooltip.style.pointerEvents = 'none';
        tooltip.style.opacity = '0';
        tooltip.style.padding = '4px 8px';

        mapContainer.value.appendChild(tooltip);
        console.log('[MapTab] å·¥å…·æç¤ºå…ƒç´ å‰µå»ºæˆåŠŸ');
      };

      /**
       * ğŸ“¥ è¼‰å…¥ç™»é©ç†±ç¶²æ ¼ GeoJSON æ•¸æ“š
       */
      const loadDengueData = async () => {
        try {
          console.log('[MapTab] é–‹å§‹è¼‰å…¥ç™»é©ç†±ç¶²æ ¼ GeoJSON æ•¸æ“š...');

          // è¼‰å…¥ç™»é©ç†±ç¶²æ ¼ GeoJSON æª”æ¡ˆ
          const dengueResponse = await fetch(
            `${process.env.BASE_URL}data/geojson/dengue_grid_counts_1km_2023_land_only.geojson`
          );

          // æª¢æŸ¥éŸ¿æ‡‰
          if (!dengueResponse.ok) {
            throw new Error(`ç™»é©ç†±ç¶²æ ¼æ•¸æ“šè¼‰å…¥å¤±æ•—: HTTP ${dengueResponse.status}`);
          }

          // è§£æ JSON
          dengueData.value = await dengueResponse.json();

          console.log('[MapTab] ç™»é©ç†±ç¶²æ ¼æ•¸æ“šè¼‰å…¥æˆåŠŸ');
          console.log('  - ç¶²æ ¼æ•¸é‡:', dengueData.value.features?.length || 0);

          return true;
        } catch (error) {
          console.error('[MapTab] ç™»é©ç†±ç¶²æ ¼æ•¸æ“šè¼‰å…¥å¤±æ•—:', error);
          return false;
        }
      };

      /**
       * ğŸ—ºï¸ ç¹ªè£½ç›´è½„å¸‚ã€ç¸£(å¸‚)ç•Œç·š
       */
      const drawCounties = () => {
        if (!g || !countyData.value) {
          console.error(
            '[MapTab] ç„¡æ³•ç¹ªè£½ç›´è½„å¸‚ã€ç¸£(å¸‚)ç•Œç·š: g=',
            !!g,
            'countyData=',
            !!countyData.value
          );
          return;
        }

        try {
          console.log('[MapTab] é–‹å§‹ç¹ªè£½ç›´è½„å¸‚ã€ç¸£(å¸‚)ç•Œç·š GeoJSON');

          // ç¹ªè£½æ‰€æœ‰ç¸£å¸‚
          g.selectAll('.county')
            .data(countyData.value.features)
            .enter()
            .append('path')
            .attr('d', path)
            .attr('class', 'county')
            .attr('fill', 'none') // ä¸å¡«å……
            .attr('stroke', '#cccccc') // æ·ºç°è‰²é‚Šæ¡†
            .attr('stroke-width', 0.5)
            .attr('stroke-opacity', 0.6);

          console.log('[MapTab] ç›´è½„å¸‚ã€ç¸£(å¸‚)ç•Œç·š GeoJSON ç¹ªè£½å®Œæˆ');
        } catch (error) {
          console.error('[MapTab] ç›´è½„å¸‚ã€ç¸£(å¸‚)ç•Œç·š GeoJSON ç¹ªè£½å¤±æ•—:', error);
        }
      };

      /**
       * ğŸ—ºï¸ ç¹ªè£½ç™»é©ç†±ç¶²æ ¼
       */
      const drawDengueGrid = () => {
        if (!g || !dengueData.value) {
          console.error('[MapTab] ç„¡æ³•ç¹ªè£½ç™»é©ç†±ç¶²æ ¼: g=', !!g, 'dengueData=', !!dengueData.value);
          return;
        }

        try {
          console.log('[MapTab] é–‹å§‹ç¹ªè£½ç™»é©ç†±ç¶²æ ¼ GeoJSON');

          // å…ˆæ¸…é™¤èˆŠçš„åœ–å±¤ï¼Œé¿å…é‡è¤‡ç–ŠåŠ é€ æˆæ•¸å­—èˆ‡é¡è‰²ä¸ä¸€è‡´
          g.selectAll('.dengue-grid').remove();
          g.selectAll('.dengue-grid-label').remove();

          // å‰µå»ºé¡è‰²æ˜ å°„ï¼Œæ ¹æ“š level å€¼ä½¿ç”¨5ç´šè‰²ç¥¨
          const maxLevel = d3.max(dengueData.value.features, (d) => d.properties.level);
          // é¡è‰²æ˜ å°„ï¼šæ·¡ç°(0) â†’ æ·±è—(1) â†’ ç¶ (2) â†’ é»ƒæ©™(3) â†’ æ©™(4) â†’ ç´…(5)
          const levelColors = {
            0: '#e0e0e0', // æ·¡ç°è‰²ï¼ˆlevel 0ï¼‰
            1: '#1a237e', // æ·±è—è‰²ï¼ˆæ·±è‰²ï¼‰
            2: '#4caf50', // ç¶ è‰²ï¼ˆè¼ƒäº®ï¼‰
            3: '#fbc02d', // é»ƒæ©™è‰²ï¼ˆé‡‘è‰²ï¼‰
            4: '#ff6f00', // æ©™è‰²ï¼ˆæ˜äº®ï¼‰
            5: '#d32f2f', // ç´…è‰²ï¼ˆæ·±è‰²ï¼‰
          };

          // é¡è‰²æ˜ å°„å‡½æ•¸
          const getColorByLevel = (level) => {
            // å¦‚æœ level æ˜¯ 0 æˆ–æœªå®šç¾©ï¼Œè¿”å›æ·¡ç°è‰²
            if (level === 0 || level === null || level === undefined) {
              return levelColors[0];
            }
            return levelColors[level] || levelColors[1];
          };

          // ç¹ªè£½æ‰€æœ‰ç¶²æ ¼ï¼ˆåŒ…æ‹¬ level 0ï¼‰
          // æŒ‰ level æ’åºï¼šlevel 0 åœ¨åº•å±¤ï¼Œlevel 1-5 åœ¨ä¸Šå±¤
          const gridsWithData = dengueData.value.features.sort((a, b) => {
            const levelA = a.properties.level || 0;
            const levelB = b.properties.level || 0;
            return levelA - levelB; // å…ˆç¹ªè£½ level 0ï¼Œå†ç¹ªè£½ level 1-5
          });

          console.log('[DEBUG] ç¸½å…±è¦ç¹ªè£½çš„ç¶²æ ¼æ•¸:', gridsWithData.length);
          console.log(
            '[DEBUG] å‰ 5 å€‹ç¶²æ ¼çš„ level:',
            gridsWithData.slice(0, 5).map((d) => ({
              grid_id: d.properties.grid_id,
              level: d.properties.level,
              point_count: d.properties.point_count,
            }))
          );

          // ç¹ªè£½æ‰€æœ‰ç™»é©ç†±ç¶²æ ¼
          g.selectAll('.dengue-grid')
            .data(gridsWithData)
            .enter()
            .append('path')
            .attr('d', path)
            .attr('class', 'dengue-grid')
            .attr('fill', (d) => {
              const color = getColorByLevel(d.properties.level);
              // Debug: åªè¨˜éŒ„å‰ 10 å€‹
              if (gridsWithData.indexOf(d) < 10) {
                console.log(
                  '[DEBUG] Grid',
                  d.properties.grid_id,
                  '- level:',
                  d.properties.level,
                  ', color:',
                  color
                );
              }
              return color;
            })
            .attr('fill-opacity', (d) => {
              const level = d.properties.level || 0;
              // æ ¹æ“š level èª¿æ•´é€æ˜åº¦ï¼Œlevel è¶Šé«˜è¶Šä¸é€æ˜
              const opacityMap = {
                0: 0.5, // level 0 æ·¡ç°è‰²ï¼Œè¼ƒé€æ˜
                1: 0.7,
                2: 0.75,
                3: 0.8,
                4: 0.85,
                5: 0.9,
              };
              return opacityMap[level] || opacityMap[0];
            })
            .attr('stroke', 'none') // ç§»é™¤é‚Šæ¡†
            .style('cursor', 'pointer') // æ·»åŠ æ‰‹å‹æ¸¸æ¨™
            .on('mouseover', function (event, d) {
              // é«˜äº®æ•ˆæœï¼šå¢åŠ é€æ˜åº¦
              d3.select(this).attr('fill-opacity', 1);

              // é¡¯ç¤ºå·¥å…·æç¤º
              if (tooltip) {
                const properties = d.properties;
                tooltip.innerHTML = `
                  <div>Grid ID: ${properties.grid_id || 'N/A'}</div>
                  <div>Point Count: ${properties.point_count || 0}</div>
                  <div>Level: ${properties.level || 'N/A'}</div>
                `;

                // ç²å–æ»‘é¼ ä½ç½®
                const [mouseX, mouseY] = d3.pointer(event, mapContainer.value);

                // è¨­ç½®å·¥å…·æç¤ºä½ç½®
                tooltip.style.left = mouseX + 10 + 'px';
                tooltip.style.top = mouseY - 10 + 'px';
                tooltip.style.opacity = 1;
              }
            })
            .on('mousemove', function (event) {
              // æ›´æ–°å·¥å…·æç¤ºä½ç½®
              if (tooltip) {
                const [mouseX, mouseY] = d3.pointer(event, mapContainer.value);
                tooltip.style.left = mouseX + 10 + 'px';
                tooltip.style.top = mouseY - 10 + 'px';
              }
            })
            .on('mouseout', function (event, d) {
              // æ¢å¾©åŸå§‹é€æ˜åº¦
              const level = d.properties.level || 0;
              const opacityMap = {
                0: 0.5, // level 0 æ·¡ç°è‰²ï¼Œè¼ƒé€æ˜
                1: 0.7,
                2: 0.75,
                3: 0.8,
                4: 0.85,
                5: 0.9,
              };
              d3.select(this).attr('fill-opacity', opacityMap[level] || opacityMap[0]);

              // éš±è—å·¥å…·æç¤º
              if (tooltip) {
                tooltip.style.opacity = 0;
              }
            });

          console.log('[MapTab] ç™»é©ç†±ç¶²æ ¼ GeoJSON ç¹ªè£½å®Œæˆ');
          console.log('  - æœ€å¤§ level:', maxLevel);
        } catch (error) {
          console.error('[MapTab] ç™»é©ç†±ç¶²æ ¼ GeoJSON ç¹ªè£½å¤±æ•—:', error);
        }
      };

      /**
       * ğŸ—ï¸ å‰µå»ºåœ°åœ–å¯¦ä¾‹
       * åˆå§‹åŒ– D3.js åœ°åœ–ä¸¦è¨­å®šåŸºæœ¬é…ç½®
       */
      const createMap = () => {
        if (!mapContainer.value) return false;

        const rect = mapContainer.value.getBoundingClientRect();
        if (rect.width === 0 || rect.height === 0) {
          console.warn('[MapTab] å®¹å™¨å°ºå¯¸ç‚ºé›¶ï¼Œå»¶é²åˆå§‹åŒ–');
          return false;
        }

        try {
          const width = rect.width;
          const height = rect.height;

          // å°ç£ä¸­å¿ƒä½ç½®ï¼šç·¯åº¦ 23.5Â°, ç¶“åº¦ 121Â°

          // å‰µå»º SVG å…ƒç´ 
          svg = d3
            .select(mapContainer.value)
            .append('svg')
            .attr('width', width)
            .attr('height', height)
            .style('background', '#ffffff'); // ç™½è‰²èƒŒæ™¯

          // å‰µå»ºæŠ•å½± - éº¥å¡æ‰˜æŠ•å½±ï¼Œèšç„¦åœ¨å°ç£
          projection = d3
            .geoMercator()
            .center([121, 23.5]) // ä¸­å¿ƒé»åœ¨å°ç£
            .scale(12000) // æ›´å¤§çš„ç¸®æ”¾æ¯”ä¾‹ï¼Œæ›´èšç„¦åœ¨å°ç£
            .translate([width / 2, height / 2]);

          // å‰µå»ºè·¯å¾‘ç”Ÿæˆå™¨
          path = d3.geoPath().projection(projection);

          // å‰µå»ºå®¹å™¨çµ„
          g = svg.append('g');

          // è¨­ç½®ç¸®æ”¾è¡Œç‚º
          zoom = d3
            .zoom()
            .scaleExtent([0.5, 50]) // å…è¨±ç¸®æ”¾ 0.5x åˆ° 50x
            .on('zoom', (event) => {
              g.attr('transform', event.transform);
            });

          svg.call(zoom);

          // å‰µå»ºå·¥å…·æç¤ºå…ƒç´ 
          createTooltip();

          isMapReady.value = true;

          // å°‡åœ°åœ–å¯¦ä¾‹å‚³éçµ¦çˆ¶çµ„ä»¶
          emit('map-ready', { svg, projection, path });

          console.log('[MapTab] D3.js åœ°åœ–å‰µå»ºæˆåŠŸ');
          return true;
        } catch (error) {
          console.error('[MapTab] D3.js åœ°åœ–å‰µå»ºå¤±æ•—:', error);
          return false;
        }
      };

      /**
       * ğŸš€ åˆå§‹åŒ–åœ°åœ–
       * å‰µå»ºåœ°åœ–ä¸¦è¼‰å…¥åˆå§‹æ•¸æ“š
       */
      const initMap = async () => {
        let attempts = 0;
        const maxAttempts = 20;

        // åŒæ™‚è¼‰å…¥å…©å€‹æ•¸æ“šé›†
        console.log('[MapTab] é–‹å§‹è¼‰å…¥æ‰€æœ‰æ•¸æ“šé›†...');
        const [countyLoaded, dengueLoaded] = await Promise.all([
          loadCountyData(),
          loadDengueData(),
        ]);

        if (!countyLoaded) {
          console.error('[MapTab] ç„¡æ³•è¼‰å…¥ç›´è½„å¸‚ã€ç¸£(å¸‚)ç•Œç·šæ•¸æ“š');
          return;
        }

        if (!dengueLoaded) {
          console.error('[MapTab] ç„¡æ³•è¼‰å…¥ç™»é©ç†±ç¶²æ ¼æ•¸æ“š');
          return;
        }

        console.log('[MapTab] æ‰€æœ‰æ•¸æ“šè¼‰å…¥å®Œæˆï¼Œé–‹å§‹å‰µå»ºåœ°åœ–');

        const tryCreateMap = async () => {
          if (attempts >= maxAttempts) {
            console.error('[MapTab] åœ°åœ–åˆå§‹åŒ–å¤±æ•—ï¼Œå·²é”åˆ°æœ€å¤§å˜—è©¦æ¬¡æ•¸');
            return;
          }

          attempts++;
          console.log(`[MapTab] å˜—è©¦å‰µå»ºåœ°åœ– (${attempts}/${maxAttempts})`);

          if (createMap()) {
            console.log('[MapTab] åœ°åœ–å‰µå»ºæˆåŠŸï¼Œé–‹å§‹ç¹ªè£½åœ–å±¤');
            // å…ˆç¹ªè£½ç¸£å¸‚ç•Œç·šï¼ˆåº•å±¤ï¼‰
            drawCounties();
            // å†ç¹ªè£½ç™»é©ç†±ç¶²æ ¼ï¼ˆä¸Šå±¤ï¼‰
            drawDengueGrid();
          } else {
            console.log('[MapTab] åœ°åœ–å‰µå»ºå¤±æ•—ï¼Œ100ms å¾Œé‡è©¦');
            setTimeout(tryCreateMap, 100);
          }
        };

        tryCreateMap();
      };

      // ğŸ§¹ ç”Ÿå‘½é€±æœŸï¼šçµ„ä»¶æ›è¼‰
      onMounted(() => {
        nextTick(() => {
          initMap();
        });
      });

      // ğŸ§¹ ç”Ÿå‘½é€±æœŸï¼šçµ„ä»¶å¸è¼‰
      onUnmounted(() => {
        if (svg) {
          svg.remove();
          svg = null;
        }

        // æ¸…ç†å·¥å…·æç¤º
        if (tooltip) {
          tooltip.remove();
          tooltip = null;
        }

        projection = null;
        path = null;
        zoom = null;
        g = null;
        isMapReady.value = false;
      });

      // ğŸ“¤ è¿”å›çµ„ä»¶å…¬é–‹çš„å±¬æ€§å’Œæ–¹æ³•
      return {
        mapContainer,
        mapContainerId,
      };
    },
  };
</script>

<template>
  <!-- ğŸ—ºï¸ åœ°åœ–ä¸»å®¹å™¨ -->
  <div id="map-container" class="h-100 w-100 position-relative bg-transparent z-0">
    <!-- ğŸ—ºï¸ Leaflet åœ°åœ–å®¹å™¨ -->
    <div :id="mapContainerId" ref="mapContainer" class="h-100 w-100"></div>
  </div>
</template>

<style scoped>
  @import '../assets/css/common.css';

  #map-container {
    overflow: hidden;
  }

  :deep(.leaflet-container) {
    background: #ffffff; /* ç™½è‰²èƒŒæ™¯ */
  }

  :deep(.leaflet-popup-content-wrapper) {
    background: rgba(0, 43, 127, 0.95); /* è«¾é­¯æ·±è—è‰²åŠé€æ˜ */
    color: #ffc61e; /* é‡‘é»ƒè‰²æ–‡å­— */
    border: 2px solid #ffc61e; /* é‡‘é»ƒè‰²é‚Šæ¡† */
  }

  :deep(.leaflet-popup-tip) {
    background: rgba(0, 43, 127, 0.95); /* è«¾é­¯æ·±è—è‰²åŠé€æ˜ */
  }

  :deep(.leaflet-tooltip) {
    background-color: rgba(0, 43, 127, 0.95) !important; /* è«¾é­¯æ·±è—è‰² */
    color: #ffc61e !important; /* é‡‘é»ƒè‰²æ–‡å­— */
    border: 1px solid #ffc61e !important; /* é‡‘é»ƒè‰²é‚Šæ¡† */
    font-size: 14px;
    padding: 8px 12px;
    border-radius: 4px;
    line-height: 1.4;
  }

  :deep(.map-tooltip) {
    background-color: #333; /* æ·±ç°è‰²èƒŒæ™¯ */
    color: #fff; /* ç™½è‰²æ–‡å­— */
    border: none; /* ç„¡é‚Šæ¡† */
  }
</style>
