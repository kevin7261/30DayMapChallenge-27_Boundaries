<script>
  /**
   * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   * ğŸ—ºï¸ MapTab.vue - Leaflet OSM å¤šåœ–å±¤åœ°åœ–çµ„ä»¶
   * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   *
   * @fileoverview
   * é€™æ˜¯ä¸€å€‹åŸºæ–¼ Leaflet çš„å¤šåœ–å±¤åœ°åœ–è¦–è¦ºåŒ–çµ„ä»¶ï¼Œä½¿ç”¨ OpenStreetMap æ•¸æ“šå’Œè«¾é­¯åœ‹æ——é…è‰²ä¸»é¡Œã€‚
   * æœ¬çµ„ä»¶è² è²¬è¼‰å…¥ã€è™•ç†å’Œæ¸²æŸ“å››ç¨®ä¸åŒçš„åœ°ç†æ•¸æ“šåœ–å±¤ï¼Œä¸¦æä¾›æµæš¢çš„åœ°åœ–äº¤äº’é«”é©—ã€‚
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ“‹ æ ¸å¿ƒåŠŸèƒ½
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * 1. å¤šåœ–å±¤æ¸²æŸ“ï¼š
   *    âœ“ åœ°é»åœ–å±¤ (Places)ï¼šè¡Œæ”¿å€åŠƒã€åŸå¸‚ã€æ‘èŠ
   *    âœ“ æ°´åŸŸåœ–å±¤ (Water)ï¼šæ¹–æ³Šã€æ²³æµã€æµ·æ´‹
   *    âœ“ é“è·¯åœ–å±¤ (Roads)ï¼šé“è·¯ç¶²çµ¡
   *    âœ“ äº¤é€šè¨­æ–½åœ–å±¤ (Transport)ï¼šæ©Ÿå ´ã€æ¸¯å£ã€è»Šç«™
   *
   * 2. è¦–è¦ºå…ƒç´ ï¼š
   *    âœ“ ç¶“ç·¯ç¶²æ ¼ç³»çµ±ï¼ˆæ¯ 10Â° ä¸€æ¢ï¼‰
   *    âœ“ èµ¤é“ç·šæ¨™ç¤ºï¼ˆé‡‘é»ƒè‰²ï¼Œå‘¼æ‡‰è«¾é­¯åœ‹æ——ï¼‰
   *    âœ“ è«¾é­¯åœ‹æ——é…è‰²ä¸»é¡Œï¼ˆæ·±è—ã€é‡‘é»ƒã€ç™½è‰²ï¼‰
   *
   * 3. äº¤äº’åŠŸèƒ½ï¼š
   *    âœ“ æ»¾è¼ªç¸®æ”¾æ§åˆ¶
   *    âœ“ æ‹–å‹•å¹³ç§»å°èˆª
   *    âœ“ è§¸æ§è¨­å‚™æ”¯æŒ
   *    âœ— ç¦ç”¨æ‡¸åœæ•ˆæœï¼ˆå°ˆæ³¨éœæ…‹å‘ˆç¾ï¼‰
   *    âœ— ç¦ç”¨å½ˆå‡ºçª—å£ï¼ˆç°¡åŒ–äº¤äº’ï¼‰
   *
   * 4. æ€§èƒ½å„ªåŒ–ï¼š
   *    âœ“ ä¸¦è¡Œè¼‰å…¥æ‰€æœ‰ GeoJSON æ•¸æ“š
   *    âœ“ Canvas æ¸²æŸ“æ¨¡å¼ï¼ˆpreferCanvas: trueï¼‰
   *    âœ“ éäº¤äº’åœ–å±¤è¨­ç½®ï¼ˆinteractive: falseï¼‰
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ¨ é…è‰²ä¸»é¡Œï¼šè«¾é­¯åœ‹æ——
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * è«¾é­¯æ·±è—  #002B7F  â†’ åœ°é»å¡«å……è‰²ã€æ°´åŸŸé‚Šæ¡†
   * èƒŒæ™¯æ·±è—  #001b4d  â†’ åœ°åœ–èƒŒæ™¯ã€æ°´åŸŸå¡«å……
   * é‡‘é»ƒè‰²    #FFC61E  â†’ èµ¤é“ç·šã€é“è·¯ã€é‚Šæ¡†
   * ç™½è‰²      #FFFFFF  â†’ ç¶“ç·¯ç¶²æ ¼ã€äº¤é€šè¨­æ–½
   *
   * é¸æ“‡è«¾é­¯é…è‰²çš„åŸå› ï¼š
   * - è«¾é­¯æ˜¯ä¸–ç•Œæœ€å°å³¶åœ‹ä¹‹ä¸€ï¼Œèˆ‡ OSM ç´°ç¯€å‘ˆç¾ç†å¿µå‘¼æ‡‰
   * - è«¾é­¯ä½æ–¼èµ¤é“é™„è¿‘ï¼Œåœ‹æ——é»ƒè‰²æ©«æ¢æ­£ä»£è¡¨èµ¤é“
   * - ä½œç‚ºå¤ªå¹³æ´‹å³¶åœ‹ï¼Œé…è‰²èˆ‡æµ·æ´‹ä¸»é¡Œå®Œç¾å¥‘åˆ
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ“Š åœ–å±¤æ¸²æŸ“é †åºï¼ˆç”±ä¸‹è‡³ä¸Šï¼‰
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * Layer 0: ç¶“ç·¯ç¶²æ ¼ (Graticule)         - ç™½è‰²åŠé€æ˜åƒè€ƒç·š
   * Layer 1: èµ¤é“ç·š (Equator)            - é‡‘é»ƒè‰²å¼·èª¿ç·š
   * Layer 2: åœ°é» (Places)               - è«¾é­¯è—å¤šé‚Šå½¢ï¼ˆåº•å±¤ï¼‰
   * Layer 3: æ°´åŸŸ (Water)                - æ·±è—è‰²æ°´é«”
   * Layer 4: é“è·¯ (Roads)                - é‡‘é»ƒè‰²ç·šæ¢
   * Layer 5: äº¤é€šè¨­æ–½ (Transport)        - ç™½è‰²å¤šé‚Šå½¢ï¼ˆé ‚å±¤ï¼‰
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ› ï¸ æŠ€è¡“æ£§
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * @requires vue                 - Vue 3.2+ (Composition API)
   * @requires leaflet             - Leaflet 1.9+ (åœ°åœ–æ¸²æŸ“åº«)
   * @requires @/stores/dataStore  - Pinia ç‹€æ…‹ç®¡ç†
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ“ æ•¸æ“šä¾†æº
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * æ‰€æœ‰ GeoJSON æ•¸æ“šä¾†è‡ª OpenStreetMap (ODbL License)
   * è·¯å¾‘ï¼špublic/data/geojson/*.geojson
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ”§ ä½¿ç”¨æ–¹å¼
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * <MapTab @map-ready="handleMapReady" />
   *
   * @event map-ready - åœ°åœ–åˆå§‹åŒ–å®Œæˆæ™‚è§¸ç™¼ï¼Œè¿”å›åœ°åœ–å¯¦ä¾‹
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ“ ç¶­è­·è€…
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * @author Kevin Cheng
   * @version 2.0.0
   * @since 2024
   * @license MIT
   *
   * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   */

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ“¦ ä¾è³´å°å…¥ (Dependencies Import)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Vue 3 æ ¸å¿ƒåŠŸèƒ½
  import { ref, onMounted, onUnmounted, nextTick } from 'vue';

  // D3.js åœ°åœ–åº«
  import * as d3 from 'd3';

  // Pinia ç‹€æ…‹ç®¡ç†
  import { useDataStore } from '@/stores/dataStore';

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ¯ çµ„ä»¶å®šç¾© (Component Definition)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  export default {
    name: 'MapTab',

    // çµ„ä»¶è§¸ç™¼çš„äº‹ä»¶
    emits: [
      'map-ready', // åœ°åœ–åˆå§‹åŒ–å®Œæˆæ™‚è§¸ç™¼ï¼Œå‚³éåœ°åœ–å¯¦ä¾‹
    ],

    /**
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * ğŸ¬ çµ„ä»¶è¨­ç½®å‡½æ•¸ (Component Setup Function)
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * ä½¿ç”¨ Vue 3 Composition API è¨­ç½®çµ„ä»¶é‚è¼¯
     *
     * @param {Object} _ - Propsï¼ˆæœ¬çµ„ä»¶ä¸ä½¿ç”¨ï¼‰
     * @param {Object} context - è¨­ç½®ä¸Šä¸‹æ–‡
     * @param {Function} context.emit - äº‹ä»¶è§¸ç™¼å‡½æ•¸
     * @returns {Object} è¿”å›æ¨¡æ¿å¯ç”¨çš„éŸ¿æ‡‰å¼æ•¸æ“šå’Œæ–¹æ³•
     */
    setup(_, { emit }) {
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“¦ ç‹€æ…‹ç®¡ç†èˆ‡ä¾è³´ (State Management & Dependencies)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      // Pinia æ•¸æ“šå­˜å„²ï¼ˆä¿ç•™ä¾›æœªä¾†æ“´å±•ä½¿ç”¨ï¼‰
      // eslint-disable-next-line no-unused-vars
      const dataStore = useDataStore();

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ—ºï¸ åœ°åœ–ç›¸é—œè®Šæ•¸ (Map-Related Variables)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      /**
       * åœ°åœ– DOM å®¹å™¨å¼•ç”¨
       * @type {Ref<HTMLElement|null>}
       */
      const mapContainer = ref(null);

      /**
       * D3.js SVG å…ƒç´ 
       * @type {d3.Selection|null}
       */
      let svg = null;

      /**
       * D3.js æŠ•å½±å‡½æ•¸
       * @type {d3.GeoProjection|null}
       */
      let projection = null;

      /**
       * D3.js è·¯å¾‘ç”Ÿæˆå™¨
       * @type {d3.GeoPath|null}
       */
      let path = null;

      /**
       * D3.js ç¸®æ”¾è¡Œç‚º
       * @type {d3.ZoomBehavior|null}
       */
      let zoom = null;

      /**
       * SVG ä¸»å®¹å™¨çµ„
       * @type {d3.Selection|null}
       */
      let g = null;

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ›ï¸ æ§åˆ¶ç‹€æ…‹ (Control States)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      /**
       * åœ°åœ–å°±ç·’ç‹€æ…‹æ¨™è¨˜
       * true = åœ°åœ–å·²åˆå§‹åŒ–å®Œæˆï¼Œfalse = å°šæœªåˆå§‹åŒ–
       * @type {Ref<boolean>}
       */
      const isMapReady = ref(false);

      /**
       * åœ°åœ–å®¹å™¨å”¯ä¸€ ID
       * ä½¿ç”¨éš¨æ©Ÿå­—ç¬¦ä¸²ç¢ºä¿å¤šå¯¦ä¾‹æ™‚ä¸æœƒè¡çª
       * @type {Ref<string>}
       */
      const mapContainerId = ref(`leaflet-map-${Math.random().toString(36).substr(2, 9)}`);

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“Š GeoJSON æ•¸æ“šå„²å­˜ (GeoJSON Data Storage)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      /**
       * åœ°é» GeoJSON æ•¸æ“š
       * ä¾†æºï¼šgis_osm_places_a_free_1.geojson
       * @type {Ref<Object|null>}
       */
      const placesData = ref(null);

      /**
       * ğŸ“¥ è¼‰å…¥ OSM åœ°é» GeoJSON æ•¸æ“š
       */
      const loadPlacesData = async () => {
        try {
          console.log('[MapTab] é–‹å§‹è¼‰å…¥ OSM åœ°é» GeoJSON æ•¸æ“š...');

          // è¼‰å…¥åœ°é» GeoJSON æª”æ¡ˆ
          const placesResponse = await fetch(
            `${process.env.BASE_URL}data/geojson/gis_osm_places_a_free_1.geojson`
          );

          // æª¢æŸ¥éŸ¿æ‡‰
          if (!placesResponse.ok) {
            throw new Error(`åœ°é»æ•¸æ“šè¼‰å…¥å¤±æ•—: HTTP ${placesResponse.status}`);
          }

          // è§£æ JSON
          placesData.value = await placesResponse.json();

          console.log('[MapTab] OSM åœ°é»æ•¸æ“šè¼‰å…¥æˆåŠŸ');
          console.log('  - åœ°é»æ•¸é‡:', placesData.value.features?.length || 0);

          return true;
        } catch (error) {
          console.error('[MapTab] OSM åœ°é»æ•¸æ“šè¼‰å…¥å¤±æ•—:', error);
          return false;
        }
      };

      /**
       * ğŸŒ ç¹ªè£½èµ¤é“ç·š
       */
      const drawEquator = () => {
        if (!g || !path) return;

        // å‰µå»ºèµ¤é“ç·šï¼ˆç·¯åº¦ 0Â°ï¼‰- ä½¿ç”¨è«¾é­¯åœ‹æ——çš„é‡‘é»ƒè‰²
        // è«¾é­¯åœ‹æ——ä¸Šçš„é»ƒè‰²æ©«æ¢ä»£è¡¨èµ¤é“
        const equatorGeoJSON = {
          type: 'LineString',
          coordinates: [
            [-180, 0],
            [180, 0],
          ],
        };

        g.append('path')
          .datum(equatorGeoJSON)
          .attr('d', path)
          .attr('class', 'equator-line')
          .attr('fill', 'none')
          .attr('stroke', '#FFC61E') // é‡‘é»ƒè‰²
          .attr('stroke-width', 3) // èµ¤é“ç·šç²—ç´°
          .style('opacity', 1);

        console.log('[MapTab] èµ¤é“ç·šç¹ªè£½å®Œæˆ');
      };

      /**
       * ğŸ—ï¸ å‰µå»ºåœ°åœ–å¯¦ä¾‹
       * åˆå§‹åŒ– D3.js åœ°åœ–ä¸¦è¨­å®šåŸºæœ¬é…ç½®
       */
      const createMap = () => {
        if (!mapContainer.value) return false;

        const rect = mapContainer.value.getBoundingClientRect();
        if (rect.width === 0 || rect.height === 0) {
          console.warn('[MapTab] å®¹å™¨å°ºå¯¸ç‚ºé›¶ï¼Œå»¶é²åˆå§‹åŒ–');
          return false;
        }

        try {
          const width = rect.width;
          const height = rect.height;

          // è«¾é­¯ï¼ˆNauruï¼‰ä½ç½®ï¼šç·¯åº¦ -0.5228Â°, ç¶“åº¦ 166.9315Â°
          // èµ¤é“ä½ç½®ï¼šç·¯åº¦ 0Â°
          // ä¸­å¿ƒé»ï¼šèµ¤é“èˆ‡è«¾é­¯ä¹‹é–“ = ç·¯åº¦ -0.26Â°, ç¶“åº¦ 166.93Â°

          // å‰µå»º SVG å…ƒç´ 
          svg = d3
            .select(mapContainer.value)
            .append('svg')
            .attr('width', width)
            .attr('height', height)
            .style('background', '#001b4d'); // æ·±è—è‰²èƒŒæ™¯

          // å‰µå»ºæŠ•å½± - éº¥å¡æ‰˜æŠ•å½±ï¼Œèšç„¦åœ¨è«¾é­¯å€åŸŸ
          projection = d3
            .geoMercator()
            .center([166.93, -0.26]) // ä¸­å¿ƒé»åœ¨èµ¤é“èˆ‡è«¾é­¯ä¹‹é–“
            .scale(300) // è¼ƒå°çš„ç¸®æ”¾æ¯”ä¾‹ï¼Œè®“èµ¤é“å’Œè«¾é­¯éƒ½æ¸…æ™°å¯è¦‹
            .translate([width / 2, height / 2]);

          // å‰µå»ºè·¯å¾‘ç”Ÿæˆå™¨
          path = d3.geoPath().projection(projection);

          // å‰µå»ºå®¹å™¨çµ„
          g = svg.append('g');

          // è¨­ç½®ç¸®æ”¾è¡Œç‚º
          zoom = d3
            .zoom()
            .scaleExtent([1, 20]) // å…è¨±ç¸®æ”¾ 1x åˆ° 20x
            .on('zoom', (event) => {
              g.attr('transform', event.transform);
            });

          svg.call(zoom);

          isMapReady.value = true;

          // å°‡åœ°åœ–å¯¦ä¾‹å‚³éçµ¦çˆ¶çµ„ä»¶
          emit('map-ready', { svg, projection, path });

          console.log('[MapTab] D3.js åœ°åœ–å‰µå»ºæˆåŠŸ');
          return true;
        } catch (error) {
          console.error('[MapTab] D3.js åœ°åœ–å‰µå»ºå¤±æ•—:', error);
          return false;
        }
      };

      /**
       * ğŸ¨ ç¹ªè£½è«¾é­¯ GeoJSON
       */
      const drawNauru = () => {
        if (!g || !placesData.value) {
          console.error('[MapTab] ç„¡æ³•ç¹ªè£½è«¾é­¯: g=', !!g, 'placesData=', !!placesData.value);
          return;
        }

        try {
          // éæ¿¾å‡ºè«¾é­¯ï¼ˆNaoeroï¼‰çš„æ•¸æ“š
          const nauruFeature = placesData.value.features.find(
            (feature) => feature.properties.name === 'Naoero'
          );

          if (!nauruFeature) {
            console.error('[MapTab] æ‰¾ä¸åˆ°è«¾é­¯ï¼ˆNaoeroï¼‰æ•¸æ“š');
            return;
          }

          console.log('[MapTab] é–‹å§‹ç¹ªè£½è«¾é­¯ GeoJSON');

          // ä½¿ç”¨ D3.js ç¹ªè£½è«¾é­¯å³¶å¶¼å¤šé‚Šå½¢
          g.append('path')
            .datum(nauruFeature)
            .attr('d', path)
            .attr('class', 'nauru')
            .attr('fill', '#FFFFFF') // ç™½è‰²å¡«å……ï¼ˆè«¾é­¯åœ‹æ——é…è‰²ï¼‰
            .attr('fill-opacity', 0.9)
            .attr('stroke', '#FFC61E') // é‡‘é»ƒè‰²é‚Šæ¡†
            .attr('stroke-width', 1);

          console.log('[MapTab] è«¾é­¯ GeoJSON ç¹ªè£½å®Œæˆ');
        } catch (error) {
          console.error('[MapTab] è«¾é­¯ GeoJSON ç¹ªè£½å¤±æ•—:', error);
        }
      };

      /**
       * ğŸš€ åˆå§‹åŒ–åœ°åœ–
       * å‰µå»ºåœ°åœ–ä¸¦è¼‰å…¥åˆå§‹æ•¸æ“š
       */
      const initMap = async () => {
        let attempts = 0;
        const maxAttempts = 20;

        // è¼‰å…¥ OSM åœ°é»æ•¸æ“š
        const loaded = await loadPlacesData();
        if (!loaded) {
          console.error('[MapTab] ç„¡æ³•è¼‰å…¥ OSM åœ°é»æ•¸æ“š');
          return;
        }

        const tryCreateMap = async () => {
          if (attempts >= maxAttempts) {
            console.error('[MapTab] åœ°åœ–åˆå§‹åŒ–å¤±æ•—ï¼Œå·²é”åˆ°æœ€å¤§å˜—è©¦æ¬¡æ•¸');
            return;
          }

          attempts++;
          console.log(`[MapTab] å˜—è©¦å‰µå»ºåœ°åœ– (${attempts}/${maxAttempts})`);

          if (createMap()) {
            console.log('[MapTab] åœ°åœ–å‰µå»ºæˆåŠŸï¼Œé–‹å§‹ç¹ªè£½åœ–å±¤');
            // ç¹ªè£½èµ¤é“ç·šï¼ˆé‡‘é»ƒè‰²ï¼‰
            drawEquator();
            // ç¹ªè£½è«¾é­¯ GeoJSONï¼ˆç™½è‰²å¤šé‚Šå½¢ï¼‰
            drawNauru();
          } else {
            console.log('[MapTab] åœ°åœ–å‰µå»ºå¤±æ•—ï¼Œ100ms å¾Œé‡è©¦');
            setTimeout(tryCreateMap, 100);
          }
        };

        tryCreateMap();
      };

      // ğŸ§¹ ç”Ÿå‘½é€±æœŸï¼šçµ„ä»¶æ›è¼‰
      onMounted(() => {
        nextTick(() => {
          initMap();
        });
      });

      // ğŸ§¹ ç”Ÿå‘½é€±æœŸï¼šçµ„ä»¶å¸è¼‰
      onUnmounted(() => {
        if (svg) {
          svg.remove();
          svg = null;
        }

        projection = null;
        path = null;
        zoom = null;
        g = null;
        isMapReady.value = false;
      });

      // ğŸ“¤ è¿”å›çµ„ä»¶å…¬é–‹çš„å±¬æ€§å’Œæ–¹æ³•
      return {
        mapContainer,
        mapContainerId,
      };
    },
  };
</script>

<template>
  <!-- ğŸ—ºï¸ åœ°åœ–ä¸»å®¹å™¨ -->
  <div id="map-container" class="h-100 w-100 position-relative bg-transparent z-0">
    <!-- ğŸ—ºï¸ Leaflet åœ°åœ–å®¹å™¨ -->
    <div :id="mapContainerId" ref="mapContainer" class="h-100 w-100"></div>
  </div>
</template>

<style scoped>
  @import '../assets/css/common.css';

  #map-container {
    overflow: hidden;
  }

  :deep(.leaflet-container) {
    background: #001b4d; /* æ·±è—è‰²èƒŒæ™¯ï¼ˆè«¾é­¯åœ‹æ——ä¸»é¡Œï¼‰ */
  }

  :deep(.leaflet-popup-content-wrapper) {
    background: rgba(0, 43, 127, 0.95); /* è«¾é­¯æ·±è—è‰²åŠé€æ˜ */
    color: #ffc61e; /* é‡‘é»ƒè‰²æ–‡å­— */
    border: 2px solid #ffc61e; /* é‡‘é»ƒè‰²é‚Šæ¡† */
  }

  :deep(.leaflet-popup-tip) {
    background: rgba(0, 43, 127, 0.95); /* è«¾é­¯æ·±è—è‰²åŠé€æ˜ */
  }

  :deep(.leaflet-tooltip) {
    background-color: rgba(0, 43, 127, 0.95) !important; /* è«¾é­¯æ·±è—è‰² */
    color: #ffc61e !important; /* é‡‘é»ƒè‰²æ–‡å­— */
    border: 1px solid #ffc61e !important; /* é‡‘é»ƒè‰²é‚Šæ¡† */
    font-size: 14px;
    padding: 8px 12px;
    border-radius: 4px;
    line-height: 1.4;
  }

  :deep(.map-tooltip) {
    background-color: rgba(0, 43, 127, 0.95); /* è«¾é­¯æ·±è—è‰² */
    color: #ffc61e; /* é‡‘é»ƒè‰²æ–‡å­— */
    border: 1px solid #ffc61e; /* é‡‘é»ƒè‰²é‚Šæ¡† */
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 14px;
    line-height: 1.4;
  }
</style>
